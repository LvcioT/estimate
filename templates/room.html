{{ template "layout.html" . }}

{{ define "content" }}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Room: {{.Room}}</h2>
            {{if eq .Role "admin"}}
            <div class="btn-group">
                <form method="POST" action="/room/{{.Room}}/reveal" class="d-flex gap-2">
                    <button name="action" value="reveal" class="btn btn-primary">Reveal Votes</button>
                    <button name="action" value="reset" class="btn btn-secondary">Reset Votes</button>
                </form>
            </div>
            {{end}}
        </div>

        <div class="row">
            {{if eq .Role "voter"}}
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Cast Your Vote</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/room/{{.Room}}/vote" hx-post="/room/{{.Room}}/vote" hx-swap="none">
                            <div class="mb-3">
                                <label for="voteValue" class="form-label">Select Story Points</label>
                                <select class="form-select" id="voteValue" name="value">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="5">5</option>
                                    <option value="8">8</option>
                                    <option value="13">13</option>
                                    <option value="20">20</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Vote</button>
                        </form>
                    </div>
                </div>
            </div>
            {{end}}

            <div class="{{if eq .Role "voter"}}col-md-8{{else}}col-12{{end}}">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Votes</h5>
                    </div>
                    <div class="card-body">
                        <div id="votes-list" hx-get="/room/{{.Room}}/votes" hx-swap="outerHTML">
                            {{template "votes_partial.html" .}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{{ end }}

{{ define "scripts" }}
<script>
(function(){
    const room = "{{.Room}}";
    const streamUrl = '/room/' + encodeURIComponent(room) + '/stream';
    const votesUrl = '/room/' + encodeURIComponent(room) + '/votes';
    const es = new EventSource(streamUrl);
    es.onmessage = function(e) {
        fetch(votesUrl).then(r=>r.text()).then(html => {
            document.getElementById('votes-list').outerHTML = html;
        }).catch(()=>{});
    };
    es.onerror = function(){ /* ignore */ };
})();
</script>
{{ end }}
